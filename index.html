<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOCX ⇄ ASCII Converter</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    :root{ 
      --bg:#121212; 
      --paper:#1e1e1e; 
      --ink:#e5e5e5; 
      --muted:#9a9a9a; 
      --line:#333; 
      --brand:#bb865d; 
      --shadow:0 2px 6px rgba(0,0,0,.6); 
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    header{background:linear-gradient(180deg,#2c1e16,#1a120d);color:#fff;padding:14px 18px;box-shadow:var(--shadow)}
    .wrap{max-width:1100px;margin:0 auto;}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    .sub{opacity:.85;font-size:12px}
    main{max-width:1100px;margin:18px auto;padding:0 14px;display:grid;gap:18px;grid-template-columns:1fr}
    @media (min-width: 980px){ main{ grid-template-columns:1fr 1fr; } }
    .card{background:var(--paper);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow)}
    .card h2{margin:0;padding:10px 14px;border-bottom:1px solid var(--line);font-size:14px;color:var(--brand)}
    .card .body{padding:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1 1 auto}
    .muted{color:var(--muted);font-size:12px}
    label.small{font-size:12px;color:var(--muted)}
    input[type="file"]{border:1px dashed var(--line);padding:8px;border-radius:8px;background:#2a2a2a;color:var(--ink)}
    textarea{
      width:100%;
      min-height:240px;
      resize:vertical;
      padding:12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#111;
      color:var(--ink);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.4);
      font:16px/1.6 "Faruma","MV Waheed","MV Faseyha","MV Elaaf",Arial,sans-serif;
    }
    textarea[dir="rtl"]{direction:rtl;unicode-bidi:plaintext}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{cursor:pointer;border:1px solid var(--line);background:linear-gradient(#2a2a2a,#1e1e1e);padding:8px 14px;border-radius:8px;font-size:13px;transition:transform .06s ease, filter .15s ease;color:var(--ink)}
    button:hover{filter:brightness(1.2)}
    button:active{transform:translateY(1px)}
    button.primary{background:linear-gradient(#bb865d,#8b5f41);color:#fff;border-color:#7a5035}
    .toast{position:fixed;right:18px;bottom:18px;background:#2b2b2b;color:#fff;padding:9px 12px;border-radius:8px;opacity:0;transform:translateY(6px);transition:opacity .2s, transform .2s}
    .toast.show{opacity:1;transform:none}
    footer{margin:24px 0;text-align:center;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>DOCX ⇄ ASCII Converter</h1>
      <div class="sub">Exact legacy keymap • Bidi-safe numbers • Works offline after first load</div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>1) Upload .docx or paste text</h2>
      <div class="body">
        <div class="row">
          <input id="file" type="file" accept=".docx" />
          <div class="spacer"></div>
          <label class="small">Mammoth.js reads .docx → plain text in your browser.</label>
        </div>
        <div class="toolbar">
          <button id="readFile" class="primary">Read .docx → Text</button>
          <button id="clearIn">Clear</button>
        </div>
        <label class="small" for="input">Raw text (from .docx or paste here)</label>
        <textarea id="input" placeholder="After reading .docx, extracted text appears here…"></textarea>
      </div>
    </section>

    <section class="card">
      <h2>2) Convert & download</h2>
      <div class="body">
        <div class="row">
          <label>Direction:</label>
          <select id="direction">
            <option value="a2t">ASCII → Thaana (Faruma)</option>
            <option value="t2a">Thaana → ASCII (legacy)</option>
          </select>
          <label class="row"><input type="checkbox" id="arabicStop"> Use Arabic full stop (۔)</label>
          <div class="spacer"></div>
          <span class="muted" id="counts">Digits flipped: 0 • Isolates added: 0</span>
        </div>
        <div class="toolbar">
          <button id="convert" class="primary">Convert</button>
          <button id="copy">Copy</button>
          <button id="download">Save .txt</button>
          <button id="clearOut">Clear</button>
        </div>
        <label class="small" for="output">Converted output</label>
        <textarea id="output" readonly placeholder="Converted output shows here…"></textarea>
      </div>
    </section>
  </main>

  <footer>By XEO</footer>

  <div class="toast" id="toast">Copied</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const elIn = $('#input');
  const elOut = $('#output');
  const elDir = $('#direction');
  const elAP  = $('#arabicStop');
  const elCounts = $('#counts');
  const toast = $('#toast');

  const asciiOrder = "hSnrbLkwvmfdtlgNsDzTypjcXHKJRCBMYZWGQVaAiIuUeEoOq";
  const THAANA_START = 0x0780 - 1;
  const a2t = Object.create(null);
  for (let i = 0; i < asciiOrder.length; i++) {
    a2t[asciiOrder[i]] = String.fromCharCode(THAANA_START + (i + 1));
  }
  a2t[','] = '\u060C'.replace(/\\u([0-9A-Fa-f]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
  a2t[';'] = '\u061B'.replace(/\\u([0-9A-Fa-f]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
  a2t['?'] = '\u061F'.replace(/\\u([0-9A-Fa-f]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
  a2t['F'] = '\uFDF2'.replace(/\\u([0-9A-Fa-f]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));

  const t2a = Object.create(null);
  Object.keys(a2t).forEach(k => { t2a[a2t[k]] = k; });

  const SEQ = /(?:\d[\d:\/.,-]*\d|\d)/g;
  const LRI = '\u2066'.replace(/\\u([0-9A-Fa-f]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
  const PDI = '\u2069'.replace(/\\u([0-9A-Fa-f]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16)));
  const HAS_ISO = /[\u2066\u2067\u2068\u2069]/;
  const stripIso = s => s.replace(/[\u2066\u2067\u2068\u2069]/g, '');
  function setCounts(d=0,i=0){ elCounts.textContent = `Digits flipped: ${d} • Isolates added: ${i}`; }
  function flipNums(s){ let d=0,i=0; const out = s.replace(SEQ, m => { d++; i++; return LRI + [...m].reverse().join('') + PDI; }); setCounts(d,i); return out; }
  function unflipIfIsolated(s){ if (!HAS_ISO.test(s)) return s; const t = stripIso(s); return t.replace(SEQ, m => [...m].reverse().join('')); }

  function toThaana(src){
    src = stripIso(src);
    let out = '';
    for (const ch of src) out += (a2t[ch] || ch);
    if (elAP.checked) out = out.replace(/(?<!\d)\.(?!\d)/g, '\u06D4'.replace(/\\u([0-9A-Fa-f]{4})/g, (_,h)=>String.fromCharCode(parseInt(h,16))));
    out = flipNums(out);
    return out;
  }
  function toAscii(src){
    src = unflipIfIsolated(src);
    let out = '';
    for (const ch of src) out += (t2a[ch] || ch);
    return out;
  }

  async function readDocx(){
    const f = $('#file').files[0];
    if (!f){ showToast('Pick a .docx file first'); return; }
    try{
      const arrayBuffer = await f.arrayBuffer();
      const result = await mammoth.extractRawText({arrayBuffer});
      elIn.value = result.value || '';
      showToast('DOCX loaded');
    }catch(e){ console.error(e); showToast('Failed to read .docx'); }
  }

  function doConvert(){
    const dir = elDir.value;
    if (dir === 'a2t'){
      elOut.setAttribute('dir','rtl');
      elOut.value = toThaana(elIn.value);
    } else {
      elOut.setAttribute('dir','ltr');
      elOut.value = toAscii(elIn.value);
      setCounts(0,0);
    }
  }

  function copyOut(){ navigator.clipboard.writeText(elOut.value).then(()=>showToast('Copied')).catch(()=>{}); }
  function saveFile(name, text){ const blob = new Blob([text], {type: 'text/plain;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 800); }
  function showToast(msg){ toast.textContent = msg || 'Done'; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 950); }

  $('#readFile').addEventListener('click', readDocx);
  $('#convert').addEventListener('click', doConvert);
  $('#copy').addEventListener('click', copyOut);
  $('#download').addEventListener('click', ()=>{ const base = elDir.value==='a2t' ? 'thaana.txt' : 'ascii.txt'; saveFile(base, elOut.value); });
  $('#clearIn').addEventListener('click', ()=>{ elIn.value=''; });
  $('#clearOut').addEventListener('click', ()=>{ elOut.value=''; setCounts(0,0); });
})();
</script>
</body>
</html>
